

<!DOCTYPE html>
<html lang="ko-kr">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="keywords" content="Development,Hacking"/>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
  <script src="https://blog.sharp0802.com/script/highlight.min.js" defer></script>

  <link rel="stylesheet" href="https://blog.sharp0802.com/style/github-markdown-light.css"/>
  <link rel="stylesheet" href="https://blog.sharp0802.com/style/hl-github.min.css"/>
  <link rel="stylesheet" href="https://blog.sharp0802.com/style/material.css"/>

  <title>11: &#xD558;&#xB4DC;&#xC6E8;&#xC5B4; &#xBCF4;&#xC548;</title>
</head>

<body>
<nav class="top">
  <div>
    <div style="height: 24px;">
      <span id="menu" class="material-symbols-outlined">menu</span>
    </div>
    <div>Sharp0802</div>
    <div>
      <img class="profile" src="https://avatars.githubusercontent.com/u/64760536?v=4" alt="profile image"/>
    </div>
  </div>
</nav>

<nav class="side">
  <div class="side-container">
    <div class="card" id="profile-container">
      <img class="profile" src="https://github.com/Sharp0802.png" alt="profile image"/>
      <ul id="contacts">
        <li>
          <h2>Sharp0802</h2>
        </li>
        <li></li>
        <li style="height: fit-content;">Game &#xB7; System developer / C &#xB7; C&#x2B;&#x2B; &#xB7; C# / LLVM &#xB7; OpenGL / A high-school student &#x1F1F0;&#x1F1F7;</li>
        <li></li>
        <li>
          <ul class="contact-entry">
            <li>
              <span class="icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="21" height="21" viewBox="0 0 24 24">
                  <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
              </span>
            </li>
            <li>
              <a href="https://github.com/Sharp0802">
                github.com/Sharp0802
              </a>
            </li>
          </ul>
        </li>
        <li>
          <ul class="contact-entry">
            <li>
              <span class="icon material-symbols-outlined">mail</span>
            </li>
            <li>
              <a href="mailto:syw0802@proton.me">syw0802@proton.me</a>
            </li>
          </ul>
        </li>
          <li>
            <ul class="contact-entry">
              <li>
                <span class="icon material-symbols-outlined">link</span>
              </li>
              <li>
                <a href="https://www.linkedin.com/in/%EC%98%81%EC%9B%90-%EC%84%9C-aa289627a/">in/&#xC601;&#xC6D0;-&#xC11C;-aa289627a</a>
              </li>
            </ul>
          </li>
      </ul>
    </div>

    <div class="card" id="tree-view-container">
      <ul id="tree-view">
        <li>
  <span class="caret">C_C++</span>
  <ul class="nested">
    <li>
      <a href="https://blog.sharp0802.com/C_C%2b%2b/2022-02-06-svml-in-clang-cl.html">Clang-cl에서 SVML 사용하기</a>
    </li>
    <li>
      <a href="https://blog.sharp0802.com/C_C%2b%2b/2023-02-23-about-nostdlib-nostartfiles.html">--nostdlib과 --nostartfiles에 대하여</a>
    </li>
    <li>
      <span class="caret">C_Tutorial</span>
      <ul class="nested">
        <li>
          <a href="https://blog.sharp0802.com/C_C%2b%2b/C_Tutorial/2023-10-23-little-endian.html">Little-Endian과 포인터</a>
        </li>
        <li>
          <a href="https://blog.sharp0802.com/C_C%2b%2b/C_Tutorial/2023-10-23-pointer.html">포인터, 더 엄밀한 포인터</a>
        </li>
        <li>
          <a href="https://blog.sharp0802.com/C_C%2b%2b/C_Tutorial/2023-10-24-array.html">배열, 더 엄밀한 배열</a>
        </li>
      </ul>
    </li>
  </ul>
</li>
<li>
  <span class="caret">C#_Unity</span>
  <ul class="nested">
    <li>
      <span class="caret">NetFramework</span>
      <ul class="nested">
        <li>
          <a href="https://blog.sharp0802.com/C%23_Unity/NetFramework/2022-02-06-accessviolationexception.html">Handling AccessViolationException</a>
        </li>
      </ul>
    </li>
    <li>
      <span class="caret">Unity</span>
      <ul class="nested">
        <li>
          <a href="https://blog.sharp0802.com/C%23_Unity/Unity/2022-03-01-ellipse-in-tilemap.html">Unity Tilemap에서 C#을 이용해 타원그리기</a>
        </li>
      </ul>
    </li>
  </ul>
</li>
<li>
  <span class="caret">Hacking</span>
  <ul class="nested">
    <li>
      <a href="https://blog.sharp0802.com/Hacking/00_define_hack.html">00: 해커와 해킹</a>
    </li>
    <li>
      <a href="https://blog.sharp0802.com/Hacking/01_think_as_hacker.html">01: 해커다운 생각</a>
    </li>
    <li>
      <a href="https://blog.sharp0802.com/Hacking/02_how_to_find_vulnerabilities.html">02: 어떻게 취약점을 찾는가</a>
    </li>
    <li>
      <a href="https://blog.sharp0802.com/Hacking/02E_how_to_find_vulnerability.html">02: 어떻게 취약점을 찾는가: 과제</a>
    </li>
    <li>
      <a href="https://blog.sharp0802.com/Hacking/03_what_is_digital_forensic.html">03: 디지털 포렌식?</a>
    </li>
    <li>
      <a href="https://blog.sharp0802.com/Hacking/04_mobile_virus_analysis.html">04: 모바일 악성코드 분석</a>
    </li>
    <li>
      <a href="https://blog.sharp0802.com/Hacking/05_bug_hunting.html">05: 버그 헌팅</a>
    </li>
    <li>
      <a href="https://blog.sharp0802.com/Hacking/06_law_for_hacker.html">06: 해킹과 법률</a>
    </li>
    <li>
      <a href="https://blog.sharp0802.com/Hacking/07_file_recovering_deleting.html">07: FS, 파일 복구 및 삭제 원리</a>
    </li>
    <li>
      <a href="https://blog.sharp0802.com/Hacking/08_financial_security.html">08: 금융 보안</a>
    </li>
    <li>
      <a href="https://blog.sharp0802.com/Hacking/09_development_model.html">09: 개발 모델, 개발 방법론</a>
    </li>
    <li>
      <a href="https://blog.sharp0802.com/Hacking/10_cryptology.html">10: 기초 암호학</a>
    </li>
    <li>
      <a href="https://blog.sharp0802.com/Hacking/11_hardware_security.html">11: 하드웨어 보안</a>
    </li>
    <li>
      <a href="https://blog.sharp0802.com/Hacking/12_pentesting.html">12: 모의해킹</a>
    </li>
  </ul>
</li>
<li>
  <a href="https://blog.sharp0802.com/index.html">Welcome!</a>
</li>

      </ul>
    </div>

    <div id="footer">
      <span>
        Made with <a href="https://github.com/Sharp0802/sika">SIKA</a>
      </span>
    </div>
  </div>
</nav>

<article>
  <main>
    <header class="card">
      <h1>11: &#xD558;&#xB4DC;&#xC6E8;&#xC5B4; &#xBCF4;&#xC548;</h1>
      <h3>Last edit on 2023-07-05</h3>
    </header>
    <div class="content">
      <div class="markdown-body">
        <h2 id="section">컴퓨터의 구조</h2>
<ol>
<li>응용 프로그램(User Space)
<ul>
<li>모든 프로그램의 실행 환경</li>
<li>일반 사용자와 관리자로 권한 구분(Ring 3)</li>
<li>백신, 실행파일 <strong>무결성 검증</strong> 필요</li>
</ul>
</li>
<li>커널(Kernel Space)
<ul>
<li>운영체제 핵심 역할 및 시스템 서비스 제공</li>
<li>과거 소프트웨어 플랫폼의 최고 권한(Ring 0)</li>
<li>a.k.a VMM(Virtual Machine Monitor)</li>
<li>커널 및 드라이버 <strong>무결성 검증</strong>(신뢰 기반) 필요</li>
</ul>
</li>
<li>하이퍼바이저
<ul>
<li>가상 머신 생성, 관리, 운영 서비스 제공</li>
<li>현재 소프트웨어 플랫폼의 최고 권한(Ring -1)
<ul>
<li>커널보다 권한이 높아 커널 무결성 검증 가능</li>
</ul>
</li>
<li>하이퍼바이저 <strong>무결성 검증</strong> 필요</li>
</ul>
</li>
<li>펌웨어
<ul>
<li>단말 하드웨어 초기화 및 단말 부팅 담당</li>
<li>하드웨어 내부의 소프트웨어</li>
<li>펌웨어 <strong>무결성 검증</strong>(신뢰 기반) 필요</li>
</ul>
</li>
<li>하드웨어
<ul>
<li>단말의 물리적 구성 담당
<ul>
<li>CPU, RAM, mainboard, HDD/SSD, TPM</li>
</ul>
</li>
<li>광학 조사 및 x-ray 투과 등으로 변조 흔적 탐지</li>
</ul>
</li>
</ol>
<p>1-3: 소프트웨어 플랫폼
4-5: 하드웨어 플랫폼</p>
<h2 id="section-1">신뢰 체인</h2>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p>선 검증, 후 실행</p>
</blockquote>
</blockquote>
<ol>
<li>하드웨어에서부터 User space로 이르기까지 먼저 무결성을 검증하고</li>
<li>User space에서 헤드웨어에 이르기까지 실행한다</li>
</ol>
<p>이러한 방법으로 신뢰 체인(trust chain)을 형성한다.</p>
<h2 id="integrity">무결성(integrity) 검증 기법</h2>
<ul>
<li>코드 서명(code signing):
<ul>
<li>실행 파일에 디지털 서명을 추가</li>
<li>서명한 이후로 실행 파일이 수정 또는 변조되는 것을 방지</li>
</ul>
</li>
<li>무결성 측정(integrity measurement):
<ul>
<li>실행파일의 측정 값(hash)을 신뢰할 수 있는 저장소에 누적
<ul>
<li>e.g.) TPM</li>
</ul>
</li>
<li>누적된 측정값을 정상 상태의 측정값과 비교하여 잔말 상태가 정상 혹은 비정상인지 확인</li>
</ul>
</li>
</ul>
<h2 id="inget-boot-guard">Inget Boot Guard</h2>
<ul>
<li>CPU와 PCH(Platform Control Hub)를 이용해 부팅 검증
<ul>
<li>Intel ME(Management Engine)에 저장된 key이용</li>
<li>이후에 실행될 Firmware(BIOS)의 서명 검증 수행</li>
</ul>
</li>
<li>UEFI활용 및 펌웨어의 서명 검증
<ul>
<li>UEFI firmware의 가장 첫 번째 모듈(Initial Boot Block, IBB)의 무결성 검증</li>
</ul>
</li>
</ul>
<h2 id="uefi-secureboot">UEFI SecureBoot</h2>
<ul>
<li>펌웨어에 내장된 key를 이용하여 서명 검증
<ul>
<li>3단계 구조(PK, KEK, DB)로 키 관리</li>
<li>BIOS 메뉴를 통해 키 추가 및 삭제 가능
<ul>
<li>주의) BIOS 관리자 패스워드 설정 필요</li>
</ul>
</li>
</ul>
</li>
<li>bootloader의 서명 확인 및 실행 담당
<ul>
<li>OS 실행에 필요한 첫 번째 모듈인 부트로더의 무결성 검증</li>
<li>이후, 하이퍼바이저 또는 커널의 무결성은 부트로더가 검증</li>
</ul>
</li>
</ul>
<h2 id="microsoft-hvci">Microsoft HVCI</h2>
<ul>
<li>하이퍼바이저에 내장된 key를 이용하여 서명 검증
<ul>
<li>Intel VT나 AMD-V를 활용하여 커널 및 머널 모듈의 실행 감시
<ul>
<li>이벤트 탐지 및 하이퍼콜(hypercall)활용</li>
</ul>
</li>
</ul>
</li>
<li>커널 및 머널 모듈의 서명 확인 및 실행 담당
<ul>
<li>OS의 핵심 영역인 커널과 커널 모듈의 무결성 검증</li>
<li>이루 runtime에 지속적으로 커널 및 모듈의 변조를 감시하고 이를 방어</li>
</ul>
</li>
</ul>
<h2 id="syscall-vs-hypercall">Syscall vs Hypercall</h2>
<ul>
<li>syscall
<ul>
<li><code>int $0x80</code></li>
<li><code>sysenter</code></li>
<li><code>syscall</code></li>
</ul>
</li>
<li>hypercall
<ul>
<li><code>vmcall</code></li>
<li>User Space에서도 Hypervisor을 호출할 수 있다!</li>
</ul>
</li>
</ul>
<h2 id="section-2">코드 서명의 장단점</h2>
<ul>
<li>장점
<ul>
<li>검증 절차가 단순 명료하고, 별도의 하드웨어가 필요 없음</li>
</ul>
</li>
<li>단점
<ul>
<li>유효성이 만료된 서명의 처리가 어려움
<ul>
<li>e.g.) 특정 응용프로그램에 취약점이 있어서 신규버전으로 업데이트 및 실행이 되었는지 확인하고 싶다면?</li>
</ul>
</li>
<li>안전한 저장공간의 부재로 서명 검증 결과를 프로그램의 실행과 연결할 수 밖에 없음</li>
</ul>
</li>
</ul>
<h2 id="tpm">TPM</h2>
<ul>
<li><p>변조 방지(tamper-resistant) 설계가 된 디바이스</p>
<ul>
<li>프로세서, RAM, ROM, NVRAM 내장</li>
<li>CPU와 별개로 자신의 상태를 유지</li>
</ul>
</li>
<li><p>암호 연산 기능과 측정값 누적 기능 제공</p>
<ul>
<li>측정값은 PCR(Platform Configuration Register)에 저장</li>
</ul>
</li>
<li><p>저장된 측정값을 이용하여 시스템 신뢰성을 판단하는데 사용 가능</p>
<ul>
<li>PCR에 저장된 값을 로컬에서 확인하거나 원격 검증(remote-attestation)을 통해 확인</li>
</ul>
</li>
<li><p>PCR의 특정 값을 이용해서 비밀(secret)에 접근 제어 가능</p>
<ul>
<li>Seal명령은 PCR 값을 이용해서 데이터를 암호화</li>
<li>Unseal명령은 PCR값을 이용해서 암호화된 데이터를 복호화</li>
<li>Microsoft Bitlocker 및 Windows Hello도 TPM 활용</li>
</ul>
</li>
</ul>
<h2 id="rtm-root-of-trust-for-measurement">RTM (Root of Trust for Measurement)</h2>
<ul>
<li>RTM은 TPM에게 측정값(measurement) 정보를 전송
<ul>
<li>TPM은 PCR에 저장된 이전 값과 함께 신규 측정값을 저장</li>
<li>Extend: <span class="math">\(PCR_{new} = Hash(PCR_{old} || Measurement_{new})\)</span></li>
</ul>
</li>
</ul>
<h2 id="state-of-the-art-boot-process">State-Of-The-Art Boot Process</h2>
<ul>
<li><p>Intel BootGuard</p>
</li>
<li><p>Intel Bios Guard</p>
</li>
<li><p>Secure Boot</p>
</li>
<li><p>TPM</p>
</li>
<li><p>OS</p>
<ul>
<li>Disk Encryption</li>
<li>Remote Attenstation</li>
</ul>
</li>
</ul>
<h2 id="section-3">전원이 켜지면</h2>
<ol>
<li>CPU는 BIOS의 코드서명 검사</li>
<li>BIOS/UEFI는 BIOS/UEFI, 부트로더의 해쉬를 TPM에 저장</li>
<li>BIOS/UEFI는 부트로더의 코드서명 검사</li>
<li>Bootloader는 커널의 해쉬를 TPM에 저장</li>
<li>부트로더는 커널의 코드서명 검사</li>
<li>Remote Attestation Server는 TPM에게 요청하여 무결성이 유지되었는지 검사</li>
</ol>
<h2 id="os">OS에 따른 최신 보안기술</h2>
<p>응용프로그램: CFI(Control-Flow Integrity)
커널: 응용프로그램 서명 검증, CFI(Control-Flow Integrity)
Hypervisor: VBS(Virtualization-Based Security) (ms-windows-only)</p>
<h2 id="section-4">경량 가상화 기반 운영체제 보호 기술</h2>
<ul>
<li><p>Intel: Light-Box(Lightweight Hypervisor)</p>
<ul>
<li>Host(Ring-1)
<ul>
<li>Shadow-Watcher(Monitor)
<ul>
<li>Guest에 대한 권한을 가진다</li>
</ul>
</li>
<li>Shared Kernel (RW)</li>
</ul>
</li>
<li>Guest(Ring 0~3)
<ul>
<li>Host를 향한 접근은 차단된다</li>
<li>Shared Kernel (R-)</li>
</ul>
</li>
</ul>
</li>
<li><p>ARM: TrustZone → Light-Box(Trusted App &amp; Trusted Kernel)</p>
<ul>
<li>Secure 영역과 다른 영역을 완전히 분리
<ol>
<li>User Application은 일반 커널과 통신한다</li>
<li>일반 커널은 Trusted Kernel(OP-TEE)에 SMC call을 보낸다</li>
<li>Trusted Kernel은 Shadow-Watcher를 통해 User Application을 모니터링한다</li>
<li>일정 기간동안 SMC call이 발생하지 않으면, Trusted Kernel은 일반 커널이 점거되었다고 간주한다</li>
</ol>
</li>
</ul>
</li>
</ul>
<h2 id="kernel-mode-heap">Kernel mode heap 할당</h2>
<p>Kernel모드에서는 메모리가 할당될때 페이지 단위로 할당된다</p>
<p>special cache가 있는 이유는 권한 관련된 오브젝트들이 오버플로우가 나면 권한상승이 되기 때문에, 이러한 취약점을 방지하기 위해 따로 일반 캐쉬로 페이지를 저장한다.</p>
<p>freelist 참조
freelist에 유휴 공간 없다면 page의 공간을 freelist로 이동
page에 유휴 공간 없다면 partial page의 공간을 freelist로 이동</p>
<h2 id="scheduler">Scheduler</h2>
<p>FCFS: First Come First Serve
SJF: Shortest Job First
- Starvation Effect
Priority:
- Every process has a priority
- Aging: The longer process is pending, the higher priority</p>
<h2 id="scheduler-option">Scheduler Option</h2>
<ul>
<li><p>CONFIG_PREEMPT_VOLUNTARY</p>
</li>
<li><p>It is default configuration for desktop</p>
</li>
<li><p>This configuration provides preemption point in kernel code</p>
</li>
<li><p>If the kernel code meets</p>
</li>
<li><p>CONFIG_PREEMPT</p>
</li>
<li><p>It is default configuration for Android</p>
</li>
<li><p>This option recudes the latency of the kernel by makign all kernel code preemptible</p>
</li>
<li><p>Except for the case when the kernel code is in the critical section</p>
</li>
</ul>

      </div>
    </div>
  </main>
</article>


<script>
  'use strict';

  // side view
  const menu = document.getElementById("menu");
  const side = document.querySelector("nav.side");
  menu.addEventListener("click", _ => {
    if (side.classList.contains("vis")) {
      menu.textContent = "menu";
      side.classList.remove("vis");
    } else {
      menu.textContent = "menu_open";
      side.classList.add("vis");
    }
  });

  // tree view
  let elements = document.getElementsByClassName("caret");
  for (let i = 0; i < elements.length; ++i) {
    let element = elements[i];
    element.addEventListener("click", () => {
      element.parentElement.querySelector(".nested").classList.toggle("active");
      element.classList.toggle("caret-down");
    })
  }
</script>

</body>

</html>